<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Form Pemesanan Kue Kering Lebaran | Worry Less</title>
<link rel="shortcut icon" href="https://worrylesshomebaker.github.io/katalog-produk/assets/logo/iconworryless.ico" type="image/x-icon" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #f59e0b; /* kuning */
    border-radius: 50%;
    width: 28px;
    height: 28px;
    animation: spin 0.9s linear infinite;
    margin: auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
  <a href="../" class="fixed top-4 left-4 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg z-50 transition duration-300">
    Home
  </a>
<body class="bg-yellow-50 text-gray-800 font-sans">
  <div class="max-w-xl mx-auto p-6 mt-10 bg-white rounded-xl shadow-md">
    <!-- Logo -->
    <div class="mb-6">
      <img src="https://worrylesshomebaker.github.io/katalog-produk/assets/logo/logo_worryless.jpeg" 
           alt="Logo Worryless" 
           class="mx-auto h-24 w-auto rounded-xl shadow-md" />
    </div>
    <h1 class="text-3xl font-bold mb-6 text-center">Form Pemesanan</h1>

    <form id="orderForm" class="space-y-4">

      <!-- Nama -->
      <div>
        <label class="block font-semibold mb-1">Nama Lengkap</label>
        <input type="text" name="nama" required class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-yellow-400" />
      </div>

      <!-- WA -->
      <div>
        <label class="block font-semibold mb-1">Nomor WhatsApp</label>
        <input type="text" name="wa" required class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-yellow-400" placeholder="0812xxxxxxx" />
      </div>

      <!-- Produk -->
      <div>
        <label class="block font-semibold mb-1">Produk</label>
        <!-- <select id="produkSelect" name="produk" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-yellow-400"></select> -->
      </div>

      <!-- Harga satuan -->
      <!-- <div>
        <label class="block font-semibold mb-1">Harga Satuan (Rp)</label>
        <input id="hargaSatuan" type="text" readonly class="w-full p-3 rounded-lg bg-gray-100 border" />
      </div> -->
      <!-- Produk -->
      <div>
        <label class="block font-semibold mb-2">Pilih Produk</label>
        <div id="produkList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
      </div>

      <!-- Jumlah pesanan -->
      <!-- <div>
        <label class="block font-semibold mb-1">Jumlah Pesanan</label>
        <input id="jumlah" type="number" min="1" name="jumlah" required class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-yellow-400" />
      </div> -->

      <!-- Metode pengambilan -->
      <div>
        <label class="block font-semibold mb-1">Metode</label>
        <div class="flex space-x-4">
          <label><input type="radio" name="metode" value="diambil" required checked> Diambil</label>
          <label><input type="radio" name="metode" value="dikirim" required> Dikirim</label>
        </div>
      </div>

      <!-- Alamat (hidden by default) -->
      <div id="alamatWrapper" class="hidden">
        <label class="block font-semibold mb-1">Alamat Pengiriman</label>
        <textarea id="alamat" name="alamat" rows="3" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-yellow-400"></textarea>
      </div>

      <!-- Biaya Packing (hidden by default) -->
      <div id="packingWrapper" class="hidden">
        <label class="block font-semibold mb-1">Biaya Packing (Rp)</label>
        <input id="biayaPacking" type="text" readonly
              class="w-full p-3 rounded-lg bg-gray-100 border"
              value="5000" />
      </div>

      <!-- Total harga -->
      <div>
        <label class="block font-semibold mb-1">Total Harga (Rp)</label>
        <input id="totalHarga" type="text" readonly class="w-full p-3 rounded-lg bg-gray-100 border" />
      </div>

<button id="submitBtn" class="relative w-full bg-yellow-500 hover:bg-yellow-600 py-3 rounded-lg font-semibold text-white flex items-center justify-center">
    <span id="submitText">Kirim Pesanan</span>
    <svg id="loader" class="hidden animate-spin ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z">
        </path>
    </svg>
</button>

    </form>

    <p id="output" class="mt-4 text-center font-semibold text-green-600 hidden">
      Pesanan berhasil dikirim!
    </p>
  </div>

<script>
const PACKING_FEE = 5000;
const scriptURL = "https://script.google.com/macros/s/AKfycbzzH2SUKN8x2gFRTZHNF1u4RqBHYgV1fkbNuc0Rb-crscVuBNiJ7OL52E33QKkwSCU/exec";

let productData = [];

/* ===============================
   LOAD PRODUK (CHECKBOX + QTY)
================================ */
fetch("../assets/kukerlebaran.json")
  .then(res => res.json())
  .then(data => {
    productData = data;
    const container = document.getElementById("produkList");

    // ambil query param ?product=
    const params = new URLSearchParams(window.location.search);
    const preselectRaw = params.get("product");
    const preselect = preselectRaw ? decodeURIComponent(preselectRaw) : "";

    data.forEach((item, i) => {
      const checked =
        preselect &&
        item.name.toLowerCase() === preselect.toLowerCase();

      container.innerHTML += `
      <div class="border rounded-xl p-4 hover:shadow-md transition">

        <!-- Checkbox + Nama -->
        <label class="flex items-start space-x-2">
          <input type="checkbox"
                class="produk-check mt-1 scale-110"
                data-index="${i}"
                ${checked ? "checked" : ""}>

          <div>
            <p class="text-sm font-semibold leading-snug">
              ${item.name}
            </p>
            <p class="text-xs text-gray-500">
              Rp${item.price.toLocaleString()}
            </p>
          </div>
        </label>

        <!-- Qty -->
        <div class="mt-3">
          <input type="number"
                min="1"
                max="50"
                value="1"
                title="Maksimal 50 pcs per produk"
                class="produk-qty w-full border rounded-lg p-2 text-center"
                data-index="${i}"
                ${checked ? "" : "disabled"}>
        </div>

      </div>
    `;
    });

    updateTotal();
  });

/* ===============================
   EVENT LISTENER CHECKBOX & QTY
================================ */
document.addEventListener("change", e => {
  // checkbox produk
  if (e.target.classList.contains("produk-check")) {
    const idx = e.target.dataset.index;
    const qty = document.querySelector(`.produk-qty[data-index="${idx}"]`);
    qty.disabled = !e.target.checked;
    updateTotal();
  }

  // qty produk
  if (e.target.classList.contains("produk-qty")) {
      if (e.target.value > 50) e.target.value = 50;
      if (e.target.value < 1) e.target.value = 1;
    updateTotal();
  }
});

/* ===============================
   METODE AMBIL / KIRIM
================================ */
document.querySelectorAll("input[name='metode']").forEach(radio => {
  radio.addEventListener("change", () => {
    const alamatWrapper = document.getElementById("alamatWrapper");
    const alamat = document.getElementById("alamat");
    const packingWrapper = document.getElementById("packingWrapper");

    if (radio.value === "dikirim") {
      alamatWrapper.classList.remove("hidden");
      packingWrapper.classList.remove("hidden");
      alamat.required = true;
    } else {
      alamatWrapper.classList.add("hidden");
      packingWrapper.classList.add("hidden");
      alamat.required = false;
      alamat.value = "";
    }

    updateTotal();
  });
});

/* ===============================
   HITUNG TOTAL
================================ */
function updateTotal() {
  let total = 0;

  document.querySelectorAll(".produk-check:checked").forEach(cb => {
    const idx = cb.dataset.index;
    const qty = Number(
      document.querySelector(`.produk-qty[data-index="${idx}"]`).value
    );
    total += productData[idx].price * qty;
  });

  const metode = document.querySelector("input[name='metode']:checked").value;
  if (metode === "dikirim") total += PACKING_FEE;

  document.getElementById("totalHarga").value = total;
}

/* ===============================
   SUBMIT FORM
================================ */
document.getElementById("orderForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const submitBtn = document.getElementById("submitBtn");
  const submitText = document.getElementById("submitText");
  const loader = document.getElementById("loader");

  submitBtn.disabled = true;
  submitText.classList.add("invisible");
  loader.classList.remove("hidden");

  const nama = e.target.nama.value;
  const wa = "'" + e.target.wa.value;
  const metode = document.querySelector("input[name='metode']:checked").value;
  const alamat = document.getElementById("alamat").value || "";
  const totalHarga = Number(
    document.getElementById("totalHarga").value.replace(/\D/g, "")
  );

  const items = [];
  let produkText = "";

  document.querySelectorAll(".produk-check:checked").forEach(cb => {
    const idx = cb.dataset.index;
    const qty = document.querySelector(`.produk-qty[data-index="${idx}"]`).value;
    const price = productData[idx].price;

    items.push({
      name: productData[idx].name,
      qty,
      price
    });

    produkText += `${productData[idx].name} x${qty} (Rp${price.toLocaleString()})\n`;
  });

  // validasi minimal 1 produk
  if (items.length === 0) {
    alert("Pilih minimal 1 produk ya ðŸ™‚");
    submitBtn.disabled = false;
    submitText.classList.remove("invisible");
    loader.classList.add("hidden");
    return;
  }

  try {
    await fetch(scriptURL, {
      method: "POST",
      body: JSON.stringify({
        nama,
        wa: String(wa),
        produk: produkText.slice(0, -2),
        items,
        total: totalHarga,
        metode,
        alamat
      })
    });

    document.getElementById('output').classList.remove('hidden');
    document.getElementById('output').textContent = "Terima kasih atas pesanan Anda! Silakan konfirmasi melalui WhatsApp jika sudah melakukan pembayaran.";
    document.getElementById('output').scrollIntoView({ behavior: "smooth" });

    e.target.reset();
    document.querySelectorAll(".produk-check").forEach(cb => cb.checked = false);
    document.querySelectorAll(".produk-qty").forEach(q => {
      q.value = 1;
      q.disabled = true;
      });
    updateTotal();
    // document.getElementById("produkList").innerHTML = "";
    // location.reload();

  } catch (err) {
    alert("Gagal mengirim pesanan! Coba lagi.");
  }

  submitBtn.disabled = false;
  submitText.classList.remove("invisible");
  loader.classList.add("hidden");
});
</script>



</body>
</html>
